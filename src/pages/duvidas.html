<style>
    sp-element {
        
        height: 100%;
    }

    main {
        justify-content: flex-start;
        align-items: center;
        flex-direction: column;
        padding: 20px;
        max-width: 100%;
        /* height: fit-content; */
    }

    main > div {
        display: flex;
        flex-direction: column;
        width: 100%;
        height: 100%;
       /*  flex-wrap: wrap; */
        /* justify-content: flex-start; */
        align-items: flex-start;
        /* justify-content: space-between; */
    }

    main section {
        display: flex;
        flex-direction: column;
        /* margin-left: 30px; */
        align-items: center;
        width: 100%;
        /* justify-content: stretch; */
    }

    form-monitoria {
        display: flex;
        /* width: fit-content; */
        /* min-width: 300px;
        max-width: 100%; */
        width: 100%;
    }

    form-monitoria textarea {
        height: 200px;
    }

    .categoria-menu {
        /* min-width: min-content;
        max-width: max-content; */
        width: 100%;
        /* height: 100%; */
    }

    .categoria-menu > div {
        display: flex;
        flex-direction: column;
        background-color: var(--color2);
        padding: 2px;
        /* max-width: max-content;
        min-width: min-content; */
        width: 100%;
        height: 100%;
    }

    .categoria-menu > div > span {
        display: flex;
        flex-direction: row;
        padding: 10px;
        justify-content: center;
        background-color: var(--color2);
        align-items: center;
    }

    .categoria-menu > div > span > * {
        margin: 0 10px;
        vertical-align: center;
    }

    #duvidas {
        display: flex;
        list-style: none;
        flex-wrap: wrap;
        max-width: max-content;
        min-width: min-content;
        height: 100%;
        min-width: 100%;
        background-color: var(--color-blank);
    }
    #duvidas > li {
        background-color: var(--color1);
        margin: 5px;
    }
    #duvidas > li.answered {
        cursor: pointer;
    }

    #duvidas > li > span {
        display: flex;
        justify-content: space-between;
        padding: 5px;
    }
    #duvidas > li > .li-header {
        text-align: center;
        background-color: var(--color3);
        user-select: none;
    }

    #duvidas > li > .li-header > p {
        font-size: 1.2em;
        font-weight: bolder;
        border: 1px solid;
        background-color: var(--color-blank);

        color: var(--color1a);
        border-color: var(--color1a);
    }

    #duvidas > li.answered > .li-header > p {
        display: flex;
        justify-content: center;
        align-items: center;
        overflow: hidden;
        position: relative;
        font-size: 1.6em;
        font-weight: bolder;
        border: none;
        background-color: unset;
        padding: 0;
        /* color: var(--color1a); */
        /* border-color: var(--color1a); */
    }

    #duvidas > li > span > * {
        padding: 5px;
    }
    #duvidas > li > span > button {
        align-items: center;
        user-select: none;
    }
</style>
<div>
    <section>
        <form-monitoria id="form-duvida" sheet="Duvidas">
            <fieldset>
                <legend>Sua d√∫vida</legend>
                <div>
                    <textarea name="content" placeholder="Duvida" required id="" maxlength="200"></textarea>
                    <span>
                        <label for="aluno">Aluno</label>
                        <input id="aluno" name="requester" type="text" placeholder="Seu nome" required>
                    </span>
                    <span>
                        <label for="trilha">Trilha</label>
                        <select name="trail" id="trilha" required></select>
                    </span>
                </div>
                <button type="submit">Enviar</button>
            </fieldset>
        </form-monitoria> 
    </section>
    <section class="categoria-menu">
        <div>
            <span>
                <h3>Trilha</h3>
                <select id="categoria"></select>
            </span>
            <ul id="duvidas"></ul>
        </div>
    </section>
</div>
<script>
    const sendDuvida = document.getElementById("form-duvida");
    sendDuvida.addEventListener("submitsucess", () => {loadDuvidas ();});

    function createOption (title, value, selected=false)
    {
        const op = document.createElement("option");
        op.innerText = title;
        op.value = value;
        if(selected) op.selected = true;
        return op;
    }

    const categoriaSelector = document.getElementById("categoria");
    categoriaSelector.append(createOption("Todos", "all", true));

    const trilhaSelector = document.getElementById("trilha");
    for(const ok in window.trilhas) 
    {
        const trilha = window.trilhas[ok];

        trilhaSelector.append(createOption(trilha.title, trilha.name));
        categoriaSelector.append(createOption(trilha.title, trilha.name));
    };

    async function loadDuvidas () 
    {
        window.duvidas = await fetch(`${window.api}?sheet=Duvidas`)
        .then(resp => resp.json())
        .then(resp => 
        {
            resp.forEach((element, index) => {
                element.id = index;
            });
            resp.sort((a,b) => b.votes - a.votes);
            console.log("Duvidas atualizada", resp);
            
            return resp;
        })
        .catch(err => console.log(err));
        const duvidasContent = document.getElementById("duvidas");
        function filterDuvidas ()
        {
            duvidasContent.innerHTML = "";
            window.duvidas.forEach((duvida) => 
            {
                if(categoriaSelector.value == "all" || categoriaSelector.value == duvida.trail)
                {
                    const li = document.createElement("li");

                    const liHeader = document.createElement("span");
                    liHeader.classList.add("li-header");
                    const h4 = document.createElement("h4");
                    const trilha = window.trilhas[duvida.trail];
                    h4.innerText = trilha.title;
                    liHeader.append(h4);

                    const span = document.createElement("span");
                    span.classList.add("li-content");
                    const op = document.createElement("p");
                    op.innerText = duvida.content;
                    span.append(op);
                    if(!duvida['answer_url'])
                    {
                        if(duvida.votes > 0)
                        {
                            const likes = document.createElement("p");
                            likes.innerText = `+${duvida.votes}`;
                            liHeader.append(likes);
                        }

                        const like = document.createElement("button");
                        like.innerText = "üëç";
                        like.onclick = () => {
                            const formData = new FormData();
                            formData.append("voting","true");
                            fetch(`${window.api}?sheet=Duvidas&index=${duvida.id+2}`,
                            { method: 'POST', body: formData })
                            .then(resp => resp.text())
                            .then(resp => 
                            {
                                console.log(resp);
                                loadDuvidas ();
                            });
                            
                        };
                        span.append(like);
                    } else {
                        const answered = document.createElement("p");
                        answered.innerText = "‚úÖ";
                        liHeader.append(answered);
                        
                        li.classList.add("answered");
                        li.onclick = ()=>
                        {
                            window.open(duvida.answer_url);
                        };
                    }

                    li.append(liHeader);
                    li.append(span);
                    duvidasContent.append(li);
                }
            });
        }
        
        categoriaSelector.onchange = filterDuvidas;
        filterDuvidas ();
    }

    loadDuvidas ();
</script>
